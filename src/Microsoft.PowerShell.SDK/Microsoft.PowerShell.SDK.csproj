<Project Sdk="Microsoft.NET.Sdk" ToolsVersion="15.0">
  <Import Project="..\..\PowerShell.Common.props" />
  <PropertyGroup>
    <Description>PowerShell SDK metapackage</Description>
    <PackageId>Microsoft.PowerShell.SDK</PackageId>
    <IncludeBuildOutput>false</IncludeBuildOutput>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Microsoft.PowerShell.Commands.Management\Microsoft.PowerShell.Commands.Management.csproj" />
    <ProjectReference Include="..\Microsoft.PowerShell.Commands.Utility\Microsoft.PowerShell.Commands.Utility.csproj" />
    <ProjectReference Include="..\Microsoft.PowerShell.ConsoleHost\Microsoft.PowerShell.ConsoleHost.csproj" />
    <ProjectReference Include="..\Microsoft.PowerShell.Security\Microsoft.PowerShell.Security.csproj" />
    <ProjectReference Include="..\System.Management.Automation\System.Management.Automation.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="System.Data.SqlClient" Version="4.4.0" />
    <PackageReference Include="System.IO.Packaging" Version="4.4.0" />
    <PackageReference Include="System.Net.Http.WinHttpHandler" Version="4.4.0" />
    <PackageReference Include="System.ServiceModel.Duplex" Version="4.4.0" />
    <PackageReference Include="System.ServiceModel.Http" Version="4.4.0" />
    <PackageReference Include="System.ServiceModel.NetTcp" Version="4.4.0" />
    <PackageReference Include="System.ServiceModel.Primitives" Version="4.4.0" />
    <PackageReference Include="System.ServiceModel.Security" Version="4.4.0" />
    <PackageReference Include="System.Text.Encodings.Web" Version="4.4.0" />
    <PackageReference Include="System.Threading.AccessControl" Version="4.4.0" />
    <PackageReference Include="System.Private.ServiceModel" Version="4.4.0" />
    <PackageReference Include="Microsoft.NETCore.Windows.ApiSets" Version="1.0.1" />
  </ItemGroup>

  <!-- TypeCatalogGen properties -->
  <PropertyGroup>
    <RefAssemblyRelPath>gen</RefAssemblyRelPath>
    <RefAssemblyFileName>RefAssemblyList.inc</RefAssemblyFileName>
    <RefAssemblyDirPath>$(MSBuildProjectDirectory)\$(RefAssemblyRelPath)</RefAssemblyDirPath>
    <RefAssemblyFilePath>$(RefAssemblyDirPath)\$(RefAssemblyFileName)</RefAssemblyFilePath>

    <CorePsTypeCatalogFilePath>$(MSBuildProjectDirectory)\..\Microsoft.PowerShell.CoreCLR.AssemblyLoadContext/CorePsTypeCatalog.cs</CorePsTypeCatalogFilePath>
    <TypeCatalogProjectFilePath>$(MSBuildProjectDirectory)\..\TypeCatalogGen\TypeCatalogGen.csproj</TypeCatalogProjectFilePath>
  </PropertyGroup>

  <!-- Create file with Assembly Reference list -->
  <Target Name="ResolveAssemblyReferencesDesignTimeSDK"
               DependsOnTargets="ResolveAssemblyReferencesDesignTime"
               Condition=" '$(DesignTimeBuild)' == 'true' ">

    <MakeDir Directories="$(RefAssemblyRelPath)" Condition=" !Exists('$(RefAssemblyRelPath)') "/>

    <ItemGroup>
        <_RefAssemblyPath Include="%(_ReferencesFromRAR.ResolvedPath)%3B" Condition=" '%(_ReferencesFromRAR.Type)' == 'assembly' And '%(_ReferencesFromRAR.PackageName)' != 'Microsoft.Management.Infrastructure' " />
    </ItemGroup>

    <ReadLinesFromFile
       File="$(RefAssemblyFilePath)" >
       <Output
          TaskParameter="Lines"
          ItemName="ItemsFromFile"/>
    </ReadLinesFromFile>

    <WriteLinesToFile
       Condition=" @(ItemsFromFile) != @(_RefAssemblyPath) "
       File="$(RefAssemblyFilePath)"
       Lines="@(_RefAssemblyPath)" Overwrite="true" />
  </Target>

  <!-- Used in standard Clean target -->
  <ItemGroup>
    <Clean Include="$(RefAssemblyDirPath)\**"/>
  </ItemGroup>

  <Target Name="TypeCatalogGen"
               DependsOnTargets="ResolveAssemblyReferencesDesignTimeSDK"
               Condition=" '$(DesignTimeBuild)' == 'true' "
               Inputs="$(RefAssemblyFilePath)"
               Outputs="$(CorePsTypeCatalogFilePath)">

    <Message Text="Project File Name" />
    <Exec Command="dotnet run --project $(TypeCatalogProjectFilePath) $(CorePsTypeCatalogFilePath) $(RefAssemblyFilePath) "/>
  </Target>

</Project>
