parameters:
  vmImage: 'win1803'
  jobName: 'Nanoserver_Tests'
  container: 'mcr.microsoft.com/powershell:nanoserver-1803'
  continueOnError: false

jobs:

- job: ${{ parameters.jobName }}
  variables:
    scriptName: ${{ parameters.scriptName }}

  pool:
    vmImage: ${{ parameters.vmImage }}
  #container: ${{ parameters.container }}

  displayName: ${{ parameters.jobName }}

  steps:
  - script: |
      set
    displayName: Capture environment
    condition: succeededOrFailed()

  - task: DownloadBuildArtifacts@0
    displayName: 'Download build artifacts'
    inputs:
      downloadType: specific
      itemPattern: |
        build/**/*
      downloadPath: '$(System.ArtifactsDirectory)'

  - pwsh: |
      Get-ChildItem "$(System.ArtifactsDirectory)\*" -Recurse
    displayName: 'Capture artifacts directory'
    continueOnError: true

  - pwsh: |
      Install-module pester -Scope CurrentUser -Force
    displayName: 'Install Pester'
    continueOnError: true

  - pwsh: |
      Import-Module .\tools\ci.psm1
      Restore-PSOptions -PSOptionsPath '$(System.ArtifactsDirectory)\build\psoptions.json'
      $options = (Get-PSOptions)
      $path = split-path -path $options.Output
      Write-Verbose "Path: '$path'" -Verbose
      $rootPath = split-Path -path $path
      $mount = 'C:\powershell'
      Expand-Archive -Path '$(System.ArtifactsDirectory)\build\build.zip' -DestinationPath $rootPath -Force
      Write-verbose "begin - capture mount contents" -verbose
      docker run --rm -v ${rootPath}:C:\powershell ${{ parameters.container }} 'C:\Program Files\PowerShell\pwsh' -c "get-childitem -path ${mount}\pwsh.exe -recurse -erroraction ignore"
      Write-verbose "end - capture mount contents" -verbose
      Describe "verify pwsh" {
        it "verify version " {
          $version = docker run --rm -v "${rootPath}:${mount}" ${{ parameters.container }} "${mount}\publish\pwsh" -NoLogo -NoProfile -Command '$PSVersionTable.PSVersion.ToString()'
          $version | Should -match '^7\.'
        }
      }
    displayName: Test
    condition: succeeded()
