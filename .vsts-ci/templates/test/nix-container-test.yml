parameters:
  pool: 'macOS-latest'
  purpose: ''
  tagSet: 'CI'
  name: 'mac'

jobs:
- job: ${{ parameters.name }}_test_${{ parameters.purpose }}_${{ parameters.tagSet }}

  dependsOn:
    - getContainerJob

  variables:
    __INCONTAINER: 1
    getContainerJob: $[ dependencies.getContainerJob.outputs['getContainerTask.containerName'] ]
    containerBuildName: $[ dependencies.getContainerJob.outputs['getContainerTask.containerBuildName'] ]

  container: $[ variables.getContainerJob ]

  pool:
    vmImage: ${{ parameters.pool }}

  displayName: ${{ parameters.name }} Test - ${{ parameters.purpose }} - ${{ parameters.tagSet }}

  steps:
    - pwsh: |
        if($env:BUILD_REASON -eq 'PullRequest') {
          Write-Host "##vso[build.updatebuildnumber]PR-$(System.PullRequest.PullRequestNumber)-$(containerBuildName)-$((get-date).ToString("yyyyMMddhhmmss"))"
        } else {
          Write-Host "##vso[build.updatebuildnumber]${env:BUILD_SOURCEBRANCHNAME}-${env:BUILD_SOURCEVERSION}-$(containerBuildName)-$((get-date).ToString("yyyyMMddhhmmss"))"
        }

        # Add tag for container that is being tested
        Write-Host "##vso[build.addbuildtag]$(containerBuildName)"
      displayName: Update build name and Add tag

    - template: ./nix-test-steps.yml
      parameters:
        purpose: ${{ parameters.purpose }}
        tagSet: ${{ parameters.tagSet }}
        buildName: $(containerBuildName)
