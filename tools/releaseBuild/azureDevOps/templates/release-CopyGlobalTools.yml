parameters:
- name: sourceContainerName
  type: string
  default: 'source-container'

- name: destinationContainerName
  type: string
  default: 'destination-container'

- name: sourceStorageAccountName
  type: string
  default: 'source-storage-account'

- name: destinationStorageAccountName
  type: string
  default: 'destination-storage-account'

- name: blobPrefix
  type: string
  default: '$(Version)'

steps:
- template: release-SetReleaseTagAndContainerName.yml

# - task: AzurePowerShell@5
#   inputs:
#     azureSubscription: '$(AzureFileCopySubscription)'
#     ScriptType: 'InlineScript'
#     Inline: |
#       $sourceContainerName = "${{ parameters.sourceContainerName }}"
#       $destinationContainerName = "${{ parameters.destinationContainerName }}"
#       $sourceStorageAccountName = "${{ parameters.sourceStorageAccountName }}"
#       $destinationStorageAccountName = "${{ parameters.destinationStorageAccountName }}"
#       $blobPrefix = "${{ parameters.blobPrefix }}"

#       Write-Verbose -Verbose "Saving params done"
#       $sourceContext = New-AzStorageContext -StorageAccountName $sourceStorageAccountName -UseConnectedAccount
#       Write-Verbose -Verbose "Source context created"
#       $destinationContext = New-AzStorageContext -StorageAccountName $destinationStorageAccountName -UseConnectedAccount
#       Write-Verbose -Verbose "Dest context created"

#       $blobs = Get-AzStorageBlob -Container $sourceContainerName -Context $sourceContext -Prefix $blobPrefix
#       Write-Verbose -Verbose "Get-AzStorageBlob done"
#       foreach ($blob in $blobs) {
#         $blobName = $blob.Name
#         $copyBlob = Start-AzStorageBlobCopy -SrcContainer $sourceContainerName -SrcBlob $blobName -DestContainer $destinationContainerName -Context $destinationContext
#         Write-Host "Copying blob $blobName from $sourceContainerName to $destinationContainerName"
#         $copyBlob = Get-AzStorageBlobCopyState -WaitForComplete
#       }
#     azurePowerShellVersion: 'LatestVersion'

- pwsh: |
    Import-module '$(BUILD.SOURCESDIRECTORY)/build.psm1'
    Install-AzCopy
  displayName: Install AzCopy
  retryCountOnTaskFailure: 2

- pwsh: |
    Import-module '$(BUILD.SOURCESDIRECTORY)/build.psm1'
    $azcopy = Find-AzCopy
    Write-Verbose -Verbose "Found AzCopy: $azcopy"

    $sourceContainerName = "${{ parameters.sourceContainerName }}"
    $destinationContainerName = "${{ parameters.destinationContainerName }}"
    $sourceStorageAccountName = "${{ parameters.sourceStorageAccountName }}"
    $destinationStorageAccountName = "${{ parameters.destinationStorageAccountName }}"
    $blobPrefix = "${{ parameters.blobPrefix }}"

    $sourceBlobUrl = "https://${sourceStorageAccountName}.blob.core.windows.net/${sourceContainerName}/${blobPrefix}"
    Write-Verbose -Verbose "Source blob url: $sourceBlobUrl"
    $destinationBlobUrl = "https://${destinationStorageAccountName}.blob.core.windows.net/${destinationContainerName}"
    Write-Verbose -Verbose "Destination blob url: $destinationBlobUrl"

    & $azcopy cp $sourceBlobUrl $destinationBlobUrl --recursive

    $packagesPath = Get-ChildItem -Path $(System.ArtifactsDirectory)\*.deb -Recurse -File | Select-Object -First 1 -ExpandProperty DirectoryName
    Write-Host "sending -- vso[task.setvariable variable=PackagesRoot]$packagesPath"
    Write-Host "##vso[task.setvariable variable=PackagesRoot]$packagesPath"

  displayName: Copy blobs
  retryCountOnTaskFailure: 2
  env:
    AZCOPY_AUTO_LOGIN_TYPE: MSI
